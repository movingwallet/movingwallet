name: Run Tests

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      # 2026-01: usamos versiones actuales de acciones (v4) por seguridad/compat.
      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@v4

      # 2026-01: instalamos pnpm explÃ­citamente (evita fallos en runners limpios).
      - name: ğŸ§© Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: pnpm

      - name: ğŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ§ª Run tests
        run: pnpm test

      # 2026-01: el â€œif: failure()â€ debe ir en un STEP (no a nivel job con otro steps).
      - name: ğŸš¨ Send Pushover notification on failure
        if: failure()
        run: |
          curl -s \
            --form-string "token=${{ secrets.PUSHOVER_API_TOKEN }}" \
            --form-string "user=${{ secrets.PUSHOVER_USER_KEY }}" \
            --form-string "title=ğŸš¨ Tests Failed" \
            --form-string "message=El workflow de tests ha fallado en ${{ github.repository }} ğŸš¨\nBranch: ${{ github.ref_name }}\nAutor: ${{ github.actor }}" \
            https://api.pushover.net/1/messages.json
