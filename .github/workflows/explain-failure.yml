name: Explain Failure

on:
  workflow_call:
    inputs:
      reason:
        description: "Failure reason hint"
        required: false
        type: string
        default: "smoke-backend failed"
      ai_provider:
        description: "AI provider used in smoke run"
        required: false
        type: string
        default: "openai"

jobs:
  explain:
    runs-on: ubuntu-latest

    steps:
      - name: "Download smoke logs"
        uses: actions/download-artifact@v4
        with:
          name: backend-smoke-logs
          path: logs

      - name: "Explain failure (human summary)"
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "❌ CI FAILURE — HUMAN SUMMARY"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""
          echo "Context:"
          echo "- Job: smoke-backend"
          echo "- Reason: ${{ inputs.reason }}"
          echo "- AI provider: ${{ inputs.ai_provider }}"
          echo ""
          echo "Most common causes:"
          echo "1) Backend did not start"
          echo "   - Port already in use"
          echo "   - Crash at startup"
          echo ""
          echo "2) /health never became ready"
          echo "   - Infinite boot"
          echo "   - Missing env vars"
          echo ""
          echo "3) AI provider credentials / quota"
          echo "   - Missing API key for the selected provider"
          echo "   - Invalid API key"
          echo "   - No credit / insufficient quota (provider dependent)"
          echo ""
          echo "Provider-specific hints:"
          echo "- openai: set OPENAI_API_KEY in GitHub Secrets; check quota/credit"
          echo "- anthropic: set ANTHROPIC_API_KEY in GitHub Secrets"
          echo "- google: set GOOGLE_API_KEY in GitHub Secrets"
          echo "- mistral: set MISTRAL_API_KEY in GitHub Secrets"
          echo ""
          echo "What to do next:"
          echo "- Check artifact: backend-smoke.log"
          echo "- Check GitHub → Settings → Secrets → Actions"
          echo "- Ensure AI_PROVIDER matches the key you configured"
          echo ""
          echo "Last 120 lines of backend-smoke.log:"
          echo "------------------------------------"
          if [ -f logs/backend-smoke.log ]; then
            tail -n 120 logs/backend-smoke.log || true
          else
            echo "(no log file found)"
          fi
