name: Explain Failure

on:
  workflow_call:
    inputs:
      reason:
        required: false
        type: string
        default: "smoke-backend failed"
      base_url:
        required: false
        type: string
        default: "http://127.0.0.1:3000"
      ai_provider:
        required: false
        type: string
        default: "openai"
    secrets:
      PUSHOVER_APP_TOKEN:
        required: false
      PUSHOVER_USER_KEY:
        required: false

jobs:
  explain:
    runs-on: ubuntu-latest

    steps:
      - name: "Download smoke logs (if present)"
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: backend-smoke-logs
          path: logs

      - name: "Explain failure + send Pushover (only on failures)"
        env:
          BASE_URL: ${{ inputs.base_url }}
          REASON: ${{ inputs.reason }}
          AI_PROVIDER: ${{ inputs.ai_provider }}
          PUSHOVER_APP_TOKEN: ${{ secrets.PUSHOVER_APP_TOKEN }}
          PUSHOVER_USER_KEY: ${{ secrets.PUSHOVER_USER_KEY }}
          REPO: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
          SERVER_URL: ${{ github.server_url }}
          WORKFLOW: ${{ github.workflow }}
          REF_NAME: ${{ github.ref_name }}
          SHA: ${{ github.sha }}
        run: |
          set -e

          LOG="logs/backend-smoke.log"
          DEBUG_JSON="debug-ai.json"
          RUN_URL="${SERVER_URL}/${REPO}/actions/runs/${RUN_ID}"

          echo "❌ CI FAILURE — DIAGNOSTIC"
          echo "Repo: $REPO"
          echo "Run:  $RUN_URL"
          echo ""

          TITLE="CI failed: ${REPO}"
          BODY=""

          if curl -sSf "${BASE_URL}/api/debug/ai" > "${DEBUG_JSON}"; then
            BODY="$(node - <<'NODE'
            const d = require("./debug-ai.json");
            const lines = [];
            lines.push(`provider=${d.provider}`);
            lines.push(`hasKey=${d.hasKey}`);
            if (d.expectedEnvVar) lines.push(`expected=${d.expectedEnvVar}`);
            if (d.openai?.model) lines.push(`model=${d.openai.model}`);
            if (d.openai?.circuitBreaker?.state)
              lines.push(`circuit=${d.openai.circuitBreaker.state}`);
            console.log(lines.join("\n"));
            NODE
            )"
          else
            if [ -f "$LOG" ]; then
              tail -n 120 "$LOG" > last.log || true
              BODY="Smoke backend failed.\nSee logs.\nRun: ${RUN_URL}"
            else
              BODY="Smoke backend failed.\nNo logs available.\nRun: ${RUN_URL}"
            fi
          fi

          BODY="${BODY}\n\nbranch=${REF_NAME}\nsha=${SHA}\nrun=${RUN_URL}"

          if [ -n "$PUSHOVER_APP_TOKEN" ] && [ -n "$PUSHOVER_USER_KEY" ]; then
            curl -s \
              --form-string "token=${PUSHOVER_APP_TOKEN}" \
              --form-string "user=${PUSHOVER_USER_KEY}" \
              --form-string "title=${TITLE}" \
              --form-string "message=${BODY}" \
              --form-string "url=${RUN_URL}" \
              --form-string "url_title=Open CI run" \
              https://api.pushover.net/1/messages.json
          fi
