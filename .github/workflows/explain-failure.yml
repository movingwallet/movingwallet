name: Explain Failure

on:
  workflow_call:
    inputs:
      reason:
        required: false
        type: string
        default: "smoke-backend failed"
      base_url:
        required: false
        type: string
        default: "http://127.0.0.1:3000"

jobs:
  explain:
    runs-on: ubuntu-latest

    steps:
      - name: "Download smoke logs"
        uses: actions/download-artifact@v4
        with:
          name: backend-smoke-logs
          path: logs

      - name: "Explain failure (deterministic first, logs fallback)"
        run: |
          set -e

          BASE_URL="${{ inputs.base_url }}"
          LOG="logs/backend-smoke.log"
          DEBUG_JSON="debug-ai.json"

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âŒ CI FAILURE â€” DIAGNOSTIC"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""

          # 1) Try deterministic diagnostic
          if curl -sSf "$BASE_URL/api/debug/ai" > "$DEBUG_JSON"; then
            echo "ðŸ§  Deterministic diagnostic from /api/debug/ai"
            echo ""

            node - <<'NODE'
            const fs = require("fs");
            const d = JSON.parse(fs.readFileSync("debug-ai.json","utf8"));

            const event = {
              source: "ci",
              kind: "ai_diagnostic",
              provider: d.provider,
              hasKey: d.hasKey,
              keyCheck: d.keyCheck,
              circuit: d?.openai?.circuitBreaker?.state || null,
              model: d?.openai?.model || null,
              baseURL: d?.openai?.baseURL || null,
              timestamp: new Date().toISOString(),
              env: "ci"
            };

            console.log("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
            console.log("ðŸ“¦ Structured diagnostic event");
            console.log("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
            console.log(JSON.stringify(event, null, 2));
            NODE

            exit 0
          fi

          # 2) Fallback to logs
          echo "âš ï¸ /api/debug/ai not reachable. Falling back to logs."
          echo ""

          if [ ! -f "$LOG" ]; then
            echo "No backend-smoke.log artifact found."
            exit 0
          fi

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ§¾ Last 140 lines of backend-smoke.log"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          tail -n 140 "$LOG" || true

  pushover:
    needs: [explain]
    if: ${{ failure() }}
    runs-on: ubuntu-latest
    steps:
      - name: "Download smoke logs (best-effort)"
        uses: actions/download-artifact@v4
        with:
          name: backend-smoke-logs
          path: logs
        continue-on-error: true

      - name: "Send Pushover notification"
        env:
          PUSHOVER_APP_TOKEN: ${{ secrets.PUSHOVER_APP_TOKEN }}
          PUSHOVER_USER_KEY: ${{ secrets.PUSHOVER_USER_KEY }}
        run: |
          set -e

          # If secrets not configured, skip silently
          if [ -z "$PUSHOVER_APP_TOKEN" ] || [ -z "$PUSHOVER_USER_KEY" ]; then
            echo "Pushover secrets missing. Skipping."
            exit 0
          fi

          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          TITLE="âŒ Workflow FAILED: ${{ github.workflow }}"
          HEADER="Repo: ${{ github.repository }} | Branch: ${{ github.ref_name }} | Actor: ${{ github.actor }}"

          LOG="logs/backend-smoke.log"
          TAIL=""
          if [ -f "$LOG" ]; then
            # Last 20 lines, compacted to avoid huge payload
            TAIL="$(tail -n 20 "$LOG" | sed 's/[[:cntrl:]]//g' | tr '\n' ' ' | cut -c1-700)"
          fi

          MSG="$HEADER | Reason: ${{ inputs.reason }} | $RUN_URL"
          if [ -n "$TAIL" ]; then
            MSG="$MSG | LogTail: $TAIL"
          fi

          curl -s \
            --form-string "token=$PUSHOVER_APP_TOKEN" \
            --form-string "user=$PUSHOVER_USER_KEY" \
            --form-string "title=$TITLE" \
            --form-string "message=$MSG" \
            --form-string "url=$RUN_URL" \
            --form-string "url_title=Open GitHub Run" \
            https://api.pushover.net/1/messages.json
