name: Explain Failure

on:
  workflow_call:
    inputs:
      reason:
        required: false
        type: string
        default: "smoke-backend failed"
      ai_provider:
        required: false
        type: string
        default: "openai"
    secrets:
      PUSHOVER_APP_TOKEN:
        required: false
      PUSHOVER_USER_KEY:
        required: false

jobs:
  explain:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: â¬‡ï¸ Checkout
        uses: actions/checkout@v4

      - name: ðŸ“¥ Download smoke artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: backend-smoke-logs
          path: logs

      - name: ðŸ§  Classify smoke failure
        run: |
          node .github/scripts/classify-smoke-failure.mjs logs > classification.json
          cat classification.json

      - name: ðŸ§¾ Build message files (title/body)
        run: |
          node -e "const fs=require('fs'); const c=JSON.parse(fs.readFileSync('classification.json','utf-8')); const title=\`[\${c.code}] \${c.title}\`; const steps=(c.nextSteps||[]).map(s=>'â€¢ '+s).join('\n'); const body=(\`\${c.summary}\n\nprovider=\${c.provider}\nexpectedEnv=\${c.expectedEnv}\nhasKey=\${c.hasKey}\n\nNext steps:\n\${steps}\n\nrepo=${{ github.repository }}\nbranch=${{ github.ref_name }}\nsha=${{ github.sha }}\nrun=${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\`).trim(); fs.writeFileSync('pushover_title.txt',title); fs.writeFileSync('pushover_body.txt',body); console.log('TITLE:\\n'+title+'\\n'); console.log('BODY:\\n'+body);"

      - name: ðŸš¨ Send Pushover notification (if configured)
        env:
          PUSHOVER_APP_TOKEN: ${{ secrets.PUSHOVER_APP_TOKEN }}
          PUSHOVER_USER_KEY: ${{ secrets.PUSHOVER_USER_KEY }}
        run: |
          set -e

          if [ -z "$PUSHOVER_APP_TOKEN" ] || [ -z "$PUSHOVER_USER_KEY" ]; then
            echo "Pushover secrets not set. Skipping notification."
            exit 0
          fi

          TITLE="$(cat pushover_title.txt)"
          BODY="$(cat pushover_body.txt)"
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          curl -s \
            --form-string "token=$PUSHOVER_APP_TOKEN" \
            --form-string "user=$PUSHOVER_USER_KEY" \
            --form-string "title=$TITLE" \
            --form-string "message=$BODY" \
            --form-string "url=$RUN_URL" \
            --form-string "url_title=Open CI run" \
            https://api.pushover.net/1/messages.json
