name: Security Triage

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * 1" # lunes 03:00 UTC
  pull_request:
    branches: ["main", "dev"]

jobs:
  security-triage:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    outputs:
      has_issues: ${{ steps.audit-status.outputs.has_issues }}

    steps:
      - name: â¬‡ï¸ Checkout
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: ğŸ§© Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: ğŸ“¦ Install dependencies (no scripts)
        run: |
          pnpm install --frozen-lockfile --ignore-scripts

      - name: ğŸ” Run pnpm audit (non-blocking)
        id: audit
        continue-on-error: true
        run: |
          pnpm audit --audit-level=high > audit.log || true
          cat audit.log

      - name: "Set audit status output"
        id: audit-status
        if: always()
        run: |
          if [ "${{ steps.audit.outcome }}" = "failure" ]; then
            echo "has_issues=true" >> $GITHUB_OUTPUT
          else
            echo "has_issues=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“¦ Upload audit artifact (only if issues)
        if: steps.audit.outcome == 'failure'
        uses: actions/upload-artifact@v4
        with:
          name: security-audit
          path: audit.log
          retention-days: 7

  notify:
    name: "Notify (Pushover)"
    needs: security-triage
    if: needs.security-triage.outputs.has_issues == 'true'
    uses: ./.github/workflows/_pushover-notify.yml
    with:
      title: "ğŸ” Security audit warnings"
      message: |
        pnpm audit detected potential vulnerabilities (level: high+).
        repo=${{ github.repository }}
        branch=${{ github.ref_name }}
        run=${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
      url: "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
      url_title: "Open security audit"
    secrets: inherit
