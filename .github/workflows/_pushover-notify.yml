name: Pushover Notify

on:
  workflow_call:
    inputs:
      title:
        required: true
        type: string
      message:
        required: true
        type: string
      url:
        required: false
        type: string
      url_title:
        required: false
        type: string
    secrets:
      PUSHOVER_APP_TOKEN:
        required: true
      PUSHOVER_USER_KEY:
        required: true

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send Pushover notification
        env:
          PUSHOVER_APP_TOKEN: ${{ secrets.PUSHOVER_APP_TOKEN }}
          PUSHOVER_USER_KEY: ${{ secrets.PUSHOVER_USER_KEY }}
          TITLE: ${{ inputs.title }}
          MESSAGE: ${{ inputs.message }}
          URL: ${{ inputs.url }}
          URL_TITLE: ${{ inputs.url_title }}
        run: |
          set -e

          FORM_ARGS=(
            --form-string "token=$PUSHOVER_APP_TOKEN"
            --form-string "user=$PUSHOVER_USER_KEY"
            --form-string "title=$TITLE"
            --form-string "message=$MESSAGE"
          )

          if [ -n "${URL:-}" ]; then
            FORM_ARGS+=( --form-string "url=$URL" )
          fi

          if [ -n "${URL_TITLE:-}" ]; then
            FORM_ARGS+=( --form-string "url_title=$URL_TITLE" )
          fi

          curl -s "${FORM_ARGS[@]}" https://api.pushover.net/1/messages.json
          echo
